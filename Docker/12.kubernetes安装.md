
## Kubernetes安装

* 主机规划

| 主机名称 | 主机IP | 用途 |
| :-- | :-- | :-- |
| test1 | 192.168.0.2 | ETCD / API Server |
| test2 | 192.168.0.3 | ETCD / Node |
| test3 | 192.168.0.4 | ETCD / Node |

* 前提条件
关闭Swap

* 网络
flannel
vxlan

* 子网
service network 10.0.0.0/12
Pod Network 10.64.0.0/10


* 安装必要软件（每台服务器执行）
```shell
yum install -y gcc gcc-c++ autoconf automake make wget openssl zlib-devel
yum install -y yum-utils device-mapper-persistent-data lvm2
yum install -y epel-release
yum install -y python-pip
pip install docker-compose
```

* 主机互信（192.168.0.2执行）
```shell
mkdir -m 700 .ssh
ssh-keygen -t rsa -b 3072
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
scp ~/.ssh/authorized_keys root@192.168.0.2:~/.ssh/
scp ~/.ssh/authorized_keys root@192.168.0.3:~/.ssh/
scp ~/.ssh/authorized_keys root@192.168.0.4:~/.ssh/
```

* CA证书签发（192.168.0.2执行）   
```shell
yum install -y openssl
mkdir -p /etc/ssl/k8s && cd /etc/ssl/k8s
touch ca.cnf
echo -e "[ req ]" >> ca.cnf
echo -e "req_extensions = v3_req" >> ca.cnf
echo -e "distinguished_name = req_distinguished_name" >> ca.cnf
echo -e "[req_distinguished_name]" >> ca.cnf
echo -e "[ v3_req ]" >> ca.cnf
echo -e "keyUsage = critical, cRLSign, keyCertSign, digitalSignature, keyEncipherment" >> ca.cnf
echo -e "extendedKeyUsage = serverAuth, clientAuth" >> ca.cnf
echo -e "subjectKeyIdentifier = hash" >> ca.cnf
echo -e "authorityKeyIdentifier = keyid:always,issuer" >> ca.cnf
echo -e "basicConstraints = critical, CA:true, pathlen:2" >> ca.cnf
openssl genrsa -out ca.key 3072
openssl req -x509 -new -nodes -key ca.key -days 1095 -out ca.pem -subj "/CN=kubernetes/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config ca.cnf -extensions v3_req
```

* API Server证书签发（192.168.0.2执行）
```shell
touch api-server.cnf
echo -e "[ req ]" >> api-server.cnf
echo -e "req_extensions = v3_req" >> api-server.cnf
echo -e "distinguished_name = req_distinguished_name" >> api-server.cnf
echo -e "[req_distinguished_name]" >> api-server.cnf
echo -e "[ v3_req ]" >> api-server.cnf
echo -e "basicConstraints = critical, CA:FALSE" >> api-server.cnf
echo -e "keyUsage = critical, digitalSignature, keyEncipherment" >> api-server.cnf
echo -e "extendedKeyUsage = serverAuth, clientAuth" >> api-server.cnf
echo -e "#subjectKeyIdentifier = hash" >> api-server.cnf
echo -e "#authorityKeyIdentifier = keyid:always,issuer" >> api-server.cnf
echo -e "subjectAltName = @alt_names" >> api-server.cnf
echo -e "[alt_names]" >> api-server.cnf
echo -e "IP.1 = 10.0.0.1" >> api-server.cnf
echo -e "IP.2 = 192.168.0.2" >> api-server.cnf
echo -e "IP.3 = 192.168.0.3" >> api-server.cnf
echo -e "IP.4 = 192.168.0.4" >> api-server.cnf
echo -e "DNS.1 = kubernetes" >> api-server.cnf
echo -e "DNS.2 = kubernetes.default" >> api-server.cnf
echo -e "DNS.3 = kubernetes.default.svc" >> api-server.cnf
echo -e "DNS.4 = kubernetes.default.svc.cluster" >> api-server.cnf
echo -e "DNS.5 = kubernetes.default.svc.cluster.local" >> api-server.cnf
openssl genrsa -out api-server.key 3072
openssl req -new -key api-server.key -out api-server.csr -subj "/CN=kubernetes/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config api-server.cnf
sed -i 's/#subjectKeyIdentifier/subjectKeyIdentifier/g' api-server.cnf
sed -i 's/#authorityKeyIdentifier/authorityKeyIdentifier/g' api-server.cnf
openssl x509 -req -in api-server.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out api-server.pem -days 1095 -extfile api-server.cnf -extensions v3_req
openssl x509 -noout -text -in api-server.pem
mkdir api-server
mv api-server*.* api-server
```

* Kubelet证书签发（192.168.0.2执行）
```shell
touch client-0-02.cnf
echo -e "[ req ]" >> client-0-02.cnf
echo -e "req_extensions = v3_req" >> client-0-02.cnf
echo -e "distinguished_name = req_distinguished_name" >> client-0-02.cnf
echo -e "[req_distinguished_name]" >> client-0-02.cnf
echo -e "[ v3_req ]" >> client-0-02.cnf
echo -e "basicConstraints = critical, CA:FALSE" >> client-0-02.cnf
echo -e "keyUsage = critical, digitalSignature, keyEncipherment" >> client-0-02.cnf
echo -e "subjectAltName = @alt_names" >> client-0-02.cnf
echo -e "[alt_names]" >> client-0-02.cnf
echo -e "IP.1 = 192.168.0.2" >> client-0-02.cnf
cp client-0-02.cnf client-0-03.cnf
cp client-0-02.cnf client-0-04.cnf
sed -i 's/192.168.0.2/192.168.0.3/g' client-0-03.cnf
sed -i 's/192.168.0.2/192.168.0.4/g' client-0-04.cnf
fn=0-02
openssl genrsa -out kubelet-$fn.key 3072
openssl req -new -key kubelet-$fn.key -out kubelet-$fn.csr -subj "/CN=admin/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=system:masters" -config client-$fn.cnf
openssl x509 -req -in kubelet-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kubelet-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-03
openssl genrsa -out kubelet-$fn.key 3072
openssl req -new -key kubelet-$fn.key -out kubelet-$fn.csr -subj "/CN=admin/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=system:masters" -config client-$fn.cnf
openssl x509 -req -in kubelet-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kubelet-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-04
openssl genrsa -out kubelet-$fn.key 3072
openssl req -new -key kubelet-$fn.key -out kubelet-$fn.csr -subj "/CN=admin/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=system:masters" -config client-$fn.cnf
openssl x509 -req -in kubelet-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kubelet-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
mkdir kubelet
mv kubelet*.* kubelet
```

* Kube-proxy证书签发（192.168.0.2执行）
```shell
fn=0-02
openssl genrsa -out kube-proxy-$fn.key 3072
openssl req -new -key kube-proxy-$fn.key -out kube-proxy-$fn.csr -subj "/CN=system:kube-proxy/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in kube-proxy-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kube-proxy-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-03
openssl genrsa -out kube-proxy-$fn.key 3072
openssl req -new -key kube-proxy-$fn.key -out kube-proxy-$fn.csr -subj "/CN=system:kube-proxy/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in kube-proxy-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kube-proxy-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-04
openssl genrsa -out kube-proxy-$fn.key 3072
openssl req -new -key kube-proxy-$fn.key -out kube-proxy-$fn.csr -subj "/CN=system:kube-proxy/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in kube-proxy-$fn.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out kube-proxy-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
mkdir kube-proxy
mv kube-proxy*.* kube-proxy
```

* ETCD证书签发（192.168.0.2执行）
```shell
fn=0-02
openssl genrsa -out etcd-$fn.key 3072
openssl req -new -key etcd-$fn.key -out etcd-$fn.csr -subj "/CN=etcd/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in etcd-$fn.csr -out etcd-$fn.pem -CA ca.pem -CAkey ca.key -CAcreateserial -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-03
openssl genrsa -out etcd-$fn.key 3072
openssl req -new -key etcd-$fn.key -out etcd-$fn.csr -subj "/CN=etcd/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in etcd-$fn.csr -out etcd-$fn.pem -CA ca.pem -CAkey ca.key -CAcreateserial -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-04
openssl genrsa -out etcd-$fn.key 3072
openssl req -new -key etcd-$fn.key -out etcd-$fn.csr -subj "/CN=etcd/OU=System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -in etcd-$fn.csr -out etcd-$fn.pem -CA ca.pem -CAkey ca.key -CAcreateserial -days 1095 -extfile client-$fn.cnf -extensions v3_req
mkdir etcd
mv etcd*.* etcd
```

* Flannel证书签发（192.168.0.2执行）
```shell
fn=0-02
openssl genrsa -out flannel-$fn.key 3072
openssl req -new -key flannel-$fn.key -out flannel-$fn.csr -subj "/CN=flanneld/OU-System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -CA ca.pem -CAkey ca.key -CAcreateserial -in flannel-$fn.csr -out flannel-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-03
openssl genrsa -out flannel-$fn.key 3072
openssl req -new -key flannel-$fn.key -out flannel-$fn.csr -subj "/CN=flanneld/OU-System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -CA ca.pem -CAkey ca.key -CAcreateserial -in flannel-$fn.csr -out flannel-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
fn=0-04
openssl genrsa -out flannel-$fn.key 3072
openssl req -new -key flannel-$fn.key -out flannel-$fn.csr -subj "/CN=flanneld/OU-System/C=CN/ST=Shanghai/L=Shanghai/O=k8s" -config client-$fn.cnf
openssl x509 -req -CA ca.pem -CAkey ca.key -CAcreateserial -in flannel-$fn.csr -out flannel-$fn.pem -days 1095 -extfile client-$fn.cnf -extensions v3_req
mkdir flannel
mv flannel*.* flannel
```

* ETCD证书分发
```shell
## 192.168.0.3/4 分别执行
mkdir -p /etc/ssl/k8s/etcd
## 192.168.0.2 执行
cd /etc/ssl/k8s/
scp -p ca.pem root@192.168.0.3:/etc/ssl/k8s/
scp -p ca.pem root@192.168.0.4:/etc/ssl/k8s/
cd /etc/ssl/k8s/etcd
scp -p etcd-0-03* root@192.168.0.3:/etc/ssl/k8s/etcd
scp -p etcd-0-04* root@192.168.0.4:/etc/ssl/k8s/etcd
```

* ETCD安装（192.168.0.2执行）
```shell
yum install -y etcd
cd /etc/etcd
fn=0-02
cp -rf /etc/ssl/k8s/etcd/etcd-$fn.* .
rm etcd-$fn.csr -f
mkdir ssl
mv etcd-0-02.* ssl
touch etcd.conf
vi etcd.conf
##拷贝文件
grep -v "^#" etcd.conf |grep -v '^$'
mkdir -p /etc/kubernetes/ssl
cp -rf /etc/ssl/k8s/ca.pem /etc/kubernetes/ssl/
touch etcd.service
vi etcd.service
##拷贝文件
cp etcd.service /usr/lib/systemd/system/etcd.service
systemctl start etcd
systemctl enable etcd
```

* ETCD添加节点（192.168.0.2执行）
```shell
etcdctl --endpoints=https://192.168.0.2:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/etcd/ssl/etcd-0-02.pem --key-file=/etc/etcd/ssl/etcd-0-02.key member add etcd2 https://192.168.0.3:2379
etcdctl --endpoints=https://192.168.0.2:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/etcd/ssl/etcd-0-02.pem --key-file=/etc/etcd/ssl/etcd-0-02.key member add etcd2 https://192.168.0.4:2379
```

* ETCD安装（192.168.0.3执行）
```shell
yum install -y etcd
cd /etc/etcd
fn=0-03
cp -rf /etc/ssl/k8s/etcd/etcd-$fn.* .
rm etcd-$fn.csr -f
mkdir ssl
mv etcd-0-03.* ssl
touch etcd.conf
vi etcd.conf
##拷贝文件
grep -v "^#" etcd.conf |grep -v '^$'
mkdir -p /etc/kubernetes/ssl
cp -rf /etc/ssl/k8s/ca.pem /etc/kubernetes/ssl/
touch etcd.service
vi etcd.service
##拷贝文件
cp etcd.service /usr/lib/systemd/system/etcd.service
systemctl start etcd
systemctl enable etcd
```

* ETCD安装（192.168.0.4执行） 
```shell
yum install -y etcd
cd /etc/etcd
fn=0-04
cp -rf /etc/ssl/k8s/etcd/etcd-$fn.* .
rm etcd-$fn.csr -f
mkdir ssl
mv etcd-0-04.* ssl
touch etcd.conf
vi etcd.conf
##拷贝文件
grep -v "^#" etcd.conf |grep -v '^$'
mkdir -p /etc/kubernetes/ssl
cp -rf /etc/ssl/k8s/ca.pem /etc/kubernetes/ssl/
touch etcd.service
vi etcd.service
##拷贝文件
cp etcd.service /usr/lib/systemd/system/etcd.service
systemctl start etcd
systemctl enable etcd
```

* 移除ETCD节点2
```shell
etcdctl --endpoints=https://192.168.0.2:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/etcd/ssl/etcd-0-02.pem --key-file=/etc/etcd/ssl/etcd-0-02.key member remove etcdid

将返回信息复制到三个节点的etcd.conf配置文件中
有启动失败的情况下，可以清空/var/lib/etcd下的内容
```
